# 🌊 Calendar Scheduler - 데이터 흐름 다이어그램

> **목적:** 시각적으로 데이터가 어떻게 흐르는지 파악  
> **대상:** 빠른 이해가 필요한 개발자

---

## 🏗️ 전체 아키텍처 (레이어 구조)

```
┌──────────────────────────────────────────────────────────┐
│                    🎨 UI Layer                            │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────┐ │
│  │  HomeScreen    │  │DateDetailView  │  │QuickAddUI  │ │
│  │  (월뷰)        │  │  (일별 상세)   │  │(입력 폼)   │ │
│  └────────┬───────┘  └────────┬───────┘  └──────┬─────┘ │
└───────────┼──────────────────┼──────────────────┼───────┘
            │                  │                  │
            ├──────────────────┴──────────────────┤
            │         StreamBuilder               │ ← 실시간 구독
            │         FutureBuilder               │ ← 일회성 조회
            └──────────────┬─────────────────────┘
                           │
┌──────────────────────────┼─────────────────────────────┐
│              💼 Business Logic Layer                    │
│  ┌───────────────────────▼──────────────────────────┐  │
│  │         AppDatabase (schedule_database.dart)     │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │ CRUD Functions:                            │  │  │
│  │  │  • createSchedule()  • watchSchedules()    │  │  │
│  │  │  • createTask()      • watchTasks()        │  │  │
│  │  │  • createHabit()     • watchHabits()       │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └────────────────────┬───────────────────────────┘  │
│                       │                               │
│  ┌────────────────────▼──────────────────────────┐  │
│  │         Validators (검증 레이어)              │  │
│  │  • EventValidators (Schedule)                 │  │
│  │  • EntityValidators (Task/Habit)              │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────┼───────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│                  🗄️ Data Layer                          │
│  ┌────────────────────────────────────────────────┐    │
│  │              Drift ORM                         │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  Table Definitions:                      │  │    │
│  │  │   • Schedule (model/schedule.dart)       │  │    │
│  │  │   • Task (model/entities.dart)           │  │    │
│  │  │   • Habit (model/entities.dart)          │  │    │
│  │  │   • HabitCompletion (model/entities.dart)│  │    │
│  │  └──────────────┬───────────────────────────┘  │    │
│  └─────────────────┼──────────────────────────────┘    │
│                    │                                    │
│  ┌─────────────────▼──────────────────────────────┐    │
│  │           SQLite Database File                 │    │
│  │         (schedule_database.sqlite)             │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  Physical Storage:                       │  │    │
│  │  │   📁 schedule (테이블)                   │  │    │
│  │  │   📁 task (테이블)                       │  │    │
│  │  │   📁 habit (테이블)                      │  │    │
│  │  │   📁 habit_completion (테이블)           │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────┘
```

---

## 🔄 Quick Add 전체 플로우 (상세)

### **1단계: 사용자 입력**

```
사용자가 "+" 버튼 클릭
         ↓
┌────────────────────────────────────────────────────────┐
│  showModalBottomSheet()                                │
│  ↓                                                     │
│  CreateEntryBottomSheet(                              │
│    selectedDate: DateTime.now(),                      │
│  )                                                     │
└────────────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────────────┐
│  QuickAddControlBox                                    │
│  ┌──────────────────────────────────────────────────┐ │
│  │  TextField                                       │ │ ← 텍스트 입력
│  │  "팀 미팅"                                       │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │  QuickDetailButton (색상 선택)                   │ │ ← 색상 선택
│  │  ColorPickerModal → selectedColorId: 'blue'      │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │  QuickDetailButton (날짜/시간 선택)              │ │ ← 날짜/시간
│  │  DateTimePickerModal → startDateTime, endDateTime│ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │  QuickAddTypeSelector                            │ │ ← 타입 선택
│  │  [일정] [할일] [습관]                            │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │  DirectAddButton (+)                             │ │ ← 저장 버튼
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
```

---

### **2단계: 데이터 수집 및 전달**

```
DirectAddButton 클릭
         ↓
┌────────────────────────────────────────────────────────┐
│  QuickAddControlBox._handleDirectAdd()                 │
│  ┌──────────────────────────────────────────────────┐ │
│  │  final data = {                                  │ │
│  │    'type': QuickAddType.schedule,                │ │
│  │    'title': '팀 미팅',                           │ │
│  │    'colorId': 'blue',                            │ │
│  │    'startDateTime': DateTime(...),               │ │
│  │    'endDateTime': DateTime(...),                 │ │
│  │  };                                              │ │
│  └──────────────────────────────────────────────────┘ │
│                      ↓                                 │
│  widget.onSave(data);  // 콜백 실행                    │
└────────────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────────────┐
│  CreateEntryBottomSheet._saveQuickAdd(data)            │
└────────────────────────────────────────────────────────┘
```

---

### **3단계: 타입별 분기 처리**

```
_saveQuickAdd(data)
         ↓
┌─────────────────────────────────────────────────────────┐
│  switch (data['type'])                                  │
└────┬────────────────────────────────┬──────────────┬────┘
     │                                │              │
     ▼                                ▼              ▼
┌──────────────┐          ┌────────────────┐  ┌────────────────┐
│  Schedule    │          │     Task       │  │    Habit       │
│  (일정)      │          │   (할일)       │  │   (습관)       │
└──────┬───────┘          └────────┬───────┘  └────────┬───────┘
       │                           │                    │
       ▼                           ▼                    ▼
┌──────────────┐          ┌────────────────┐  ┌────────────────┐
│ScheduleComp  │          │ 1. validate... │  │ 1. validate... │
│anion.insert()│          │ EntityValid... │  │ EntityValid... │
└──────┬───────┘          └────────┬───────┘  └────────┬───────┘
       │                           │                    │
       │                           ▼                    ▼
       │                  ┌────────────────┐  ┌────────────────┐
       │                  │ 2. TaskComp... │  │ 2. HabitComp...│
       │                  │ anion.insert() │  │ anion.insert() │
       │                  └────────┬───────┘  └────────┬───────┘
       │                           │                    │
       └───────────────────────────┴────────────────────┘
                                   ↓
                        ┌──────────────────────┐
                        │  GetIt.I<AppDatabase>│
                        │  .create...()        │
                        └──────────┬───────────┘
                                   │
                                   ▼
                        ┌──────────────────────┐
                        │  SQLite DB 저장      │
                        └──────────┬───────────┘
                                   │
                                   ▼
                        ┌──────────────────────┐
                        │  Stream emit 🔴      │
                        └──────────┬───────────┘
                                   │
                                   ▼
                        ┌──────────────────────┐
                        │  UI 자동 갱신 ✨     │
                        └──────────────────────┘
```

---

## 🎭 타입별 상세 플로우

### **📅 Schedule (일정) 저장**

```
_saveQuickAdd(data) → type == 'schedule'
         ↓
┌───────────────────────────────────────────────────────┐
│  ScheduleCompanion.insert(                            │
│    start: data['startDateTime'],                      │
│    end: data['endDateTime'],                          │
│    summary: data['title'],                            │
│    colorId: data['colorId'],                          │
│    description: '',                                   │
│    location: '',                                      │
│    repeatRule: '',                                    │
│    alertSetting: '',                                  │
│    status: 'confirmed',                               │
│    visibility: 'public',                              │
│  )                                                     │
└─────────────────────┬─────────────────────────────────┘
                      ↓
         database.createSchedule(companion)
                      ↓
         ┌────────────────────────────┐
         │  into(schedule).insert()   │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  SQLite INSERT             │
         │  → 새 행 생성              │
         │  → id 자동 생성 (예: 42)  │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  watchSchedules() 구독자들 │
         │  자동 알림 🔴              │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  StreamBuilder rebuild     │
         │  → UI에 "팀 미팅" 표시 ✨  │
         └────────────────────────────┘
```

---

### **✅ Task (할일) 저장**

```
_saveQuickAdd(data) → type == 'task'
         ↓
┌───────────────────────────────────────────────────────┐
│  1. 검증 단계                                         │
│  EntityValidators.validateCompleteTask(               │
│    title: data['title'],                              │
│    dueDate: data['dueDate'],                          │
│    colorId: data['colorId'],                          │
│  )                                                     │
│                  ↓                                     │
│  result = {                                           │
│    'isValid': true/false,                             │
│    'errors': {},                                      │
│    'warnings': [],                                    │
│  }                                                     │
└─────────────────────┬─────────────────────────────────┘
                      ↓
         ┌────────────────────────────┐
         │  if (!result['isValid'])   │
         │    print('❌ 검증 실패')   │
         │    return; (저장 중단)     │
         └────────────┬───────────────┘
                      ↓ (검증 통과)
┌───────────────────────────────────────────────────────┐
│  2. DB 저장 단계                                      │
│  TaskCompanion.insert(                                │
│    title: data['title'],                              │
│    createdAt: DateTime.now(),                         │
│    colorId: Value(data['colorId']),                   │
│    completed: Value(false),                           │
│    dueDate: Value(data['dueDate']),                   │
│    listId: Value('inbox'),                            │
│  )                                                     │
└─────────────────────┬─────────────────────────────────┘
                      ↓
         database.createTask(companion)
                      ↓
         ┌────────────────────────────┐
         │  into(task).insert()       │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  SQLite INSERT             │
         │  → 새 행 생성              │
         │  → id 자동 생성 (예: 15)  │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  watchTasks() 구독자들     │
         │  자동 알림 🔴              │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  StreamBuilder rebuild     │
         │  → UI에 할일 표시 ✨       │
         └────────────────────────────┘
```

---

### **🔁 Habit (습관) 저장**

```
_saveQuickAdd(data) → type == 'habit'
         ↓
┌───────────────────────────────────────────────────────┐
│  1. 검증 단계                                         │
│  EntityValidators.validateCompleteHabit(              │
│    title: data['title'],                              │
│    repeatRule: data['repeatRule'],                    │
│    colorId: data['colorId'],                          │
│  )                                                     │
└─────────────────────┬─────────────────────────────────┘
                      ↓ (검증 통과)
┌───────────────────────────────────────────────────────┐
│  2. DB 저장 단계                                      │
│  HabitCompanion.insert(                               │
│    title: data['title'],                              │
│    createdAt: DateTime.now(),                         │
│    repeatRule: '{"mon":true,"tue":true,...}',         │
│    colorId: Value(data['colorId']),                   │
│  )                                                     │
└─────────────────────┬─────────────────────────────────┘
                      ↓
         database.createHabit(companion)
                      ↓
         ┌────────────────────────────┐
         │  into(habit).insert()      │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  SQLite INSERT             │
         │  → 새 행 생성              │
         │  → id 자동 생성 (예: 7)   │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  watchHabits() 구독자들    │
         │  자동 알림 🔴              │
         └────────────┬───────────────┘
                      ↓
         ┌────────────────────────────┐
         │  StreamBuilder rebuild     │
         │  → UI에 습관 표시 ✨       │
         └────────────────────────────┘
```

---

## 🔍 Stream vs Future 비교

### **Future (일회성 조회)**

```
┌──────────────────────────────────────────────────────┐
│  FutureBuilder                                       │
│  future: database.getSchedules(),                    │
└─────────────────┬────────────────────────────────────┘
                  │ initState()에서 한 번만 실행
                  ↓
         ┌────────────────────┐
         │  DB 조회 1회       │
         └────────┬───────────┘
                  │ 결과 반환
                  ↓
         ┌────────────────────┐
         │  snapshot.data     │
         │  → UI 렌더링       │
         └────────────────────┘
                  
         ⚠️ 문제점:
         • DB가 변경되어도 UI 업데이트 안 됨
         • 수동으로 setState() 필요
```

---

### **Stream (실시간 구독) ✨**

```
┌──────────────────────────────────────────────────────┐
│  StreamBuilder                                       │
│  stream: database.watchSchedules(),                  │
└─────────────────┬────────────────────────────────────┘
                  │ initState()에서 구독 시작
                  ↓
         ┌────────────────────┐
         │  DB 구독 (watch)   │
         │  → 변경 감지 대기🔴│
         └────────┬───────────┘
                  │ 초기 데이터
                  ↓
         ┌────────────────────┐
         │  snapshot.data     │
         │  → UI 렌더링       │
         └────────────────────┘
                  
         (사용자가 새 일정 추가)
                  ↓
         ┌────────────────────┐
         │  DB INSERT         │
         └────────┬───────────┘
                  │ 변경 감지 🔴
                  ↓
         ┌────────────────────┐
         │  Stream emit       │
         │  → 새 데이터 전달  │
         └────────┬───────────┘
                  │ 자동 rebuild
                  ↓
         ┌────────────────────┐
         │  snapshot.data     │
         │  → UI 자동 갱신 ✨ │
         └────────────────────┘
         
         ✅ 장점:
         • 자동 UI 갱신
         • setState() 불필요
         • 실시간 반영
```

---

## 🧩 테이블 간 관계 (ERD)

```
┌─────────────────────────────────────────────────────────────┐
│                        Schedule                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  id (PK)  │ start  │ end  │ summary │ colorId │ ...  │ │
│  ├───────────────────────────────────────────────────────┤ │
│  │  1        │ 14:00  │ 16:00│ 팀 미팅 │ blue    │ ...  │ │
│  │  2        │ 09:00  │ 10:00│ 운동    │ green   │ ...  │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                          Task                               │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ id (PK) │ title  │ completed │ dueDate │ colorId │...│ │
│  ├───────────────────────────────────────────────────────┤ │
│  │ 1       │ 보고서 │ false     │ 10-31   │ orange  │...│ │
│  │ 2       │ 메일   │ true      │ 10-15   │ red     │...│ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         Habit                               │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ id (PK) │ title  │ repeatRule       │ colorId │ ...  │ │
│  ├───────────────────────────────────────────────────────┤ │
│  │ 1       │ 운동   │ {"mon":true,...} │ green   │ ...  │ │
│  │ 2       │ 독서   │ {"sun":true,...} │ blue    │ ...  │ │
│  └───────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │ 1:N 관계
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                   HabitCompletion                           │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ id (PK) │ habitId (FK) │ completedDate │ createdAt  │ │
│  ├───────────────────────────────────────────────────────┤ │
│  │ 1       │ 1            │ 2025-10-14    │ 2025-10-14 │ │
│  │ 2       │ 1            │ 2025-10-15    │ 2025-10-15 │ │
│  │ 3       │ 2            │ 2025-10-14    │ 2025-10-14 │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

📝 설명:
• Schedule, Task, Habit은 독립적인 테이블
• HabitCompletion은 Habit의 자식 테이블 (1:N)
• habitId로 외래키 관계 설정
```

---

## 🚦 DB 작업 순서도

### **Habit 삭제 시 (Cascade Delete)**

```
사용자가 "아침 운동" 습관 삭제 요청
         ↓
database.deleteHabit(id: 7)
         ↓
┌──────────────────────────────────────────────────────┐
│  1단계: 완료 기록 먼저 삭제                          │
│  delete(habitCompletion)                             │
│    .where(tbl.habitId.equals(7))                     │
│    .go()                                             │
│                                                      │
│  → HabitCompletion 테이블에서 habitId=7인 모든 행 삭제│
└────────────────────┬─────────────────────────────────┘
                     ↓
┌──────────────────────────────────────────────────────┐
│  2단계: 습관 본체 삭제                               │
│  delete(habit)                                       │
│    .where(tbl.id.equals(7))                          │
│    .go()                                             │
│                                                      │
│  → Habit 테이블에서 id=7인 행 삭제                   │
└────────────────────┬─────────────────────────────────┘
                     ↓
┌──────────────────────────────────────────────────────┐
│  3단계: Stream 알림                                  │
│  watchHabits() 구독자들에게 변경 알림 🔴             │
└────────────────────┬─────────────────────────────────┘
                     ↓
         ┌────────────────────────┐
         │  UI 자동 갱신          │
         │  → "아침 운동" 사라짐 │
         └────────────────────────┘

⚠️ 중요: 완료 기록을 먼저 삭제해야 외래키 제약조건 오류 방지
```

---

## 🎯 Quick Reference (자주 쓰는 패턴)

### **1. 특정 날짜 일정 조회**

```dart
StreamBuilder<List<ScheduleData>>(
  stream: database.watchByDay(selectedDate),
  builder: (context, snapshot) {
    if (!snapshot.hasData) return CircularProgressIndicator();
    final schedules = snapshot.data!;
    return ListView.builder(...);
  },
)
```

---

### **2. 할일 완료 처리**

```dart
onTap: () async {
  await database.completeTask(task.id);
  // ✅ Stream이 자동으로 UI 갱신
}
```

---

### **3. 습관 완료 기록 추가**

```dart
onTap: () async {
  await database.recordHabitCompletion(
    habit.id,
    DateTime.now(),
  );
  // ✅ HabitCompletion 테이블에 새 행 추가
}
```

---

### **4. 오늘 완료한 습관 확인**

```dart
final completions = await database.getHabitCompletionsByDate(
  DateTime.now(),
);

// completions.map((c) => c.habitId) → 완료한 습관 ID 목록
```

---

## 📊 성능 모니터링

### **로그로 성능 파악하기**

```
✅ [DB] createSchedule 실행 완료: ID=42로 일정 생성됨
   → 제목: 팀 미팅
   → 시작: 2025-10-14 14:30:00.000
   → 종료: 2025-10-14 16:00:00.000
   
👀 [DB] watchByDay 스트림 시작: 2025-10-14 - 실시간 관찰 중
   
🗑️ [DB] deleteTask 실행 완료: ID=15 → 1개 행 삭제됨
```

**성능 측정 팁:**
- `print('⏱️ 시작: ${DateTime.now()}')` → 함수 시작
- `print('⏱️ 완료: ${DateTime.now()}')` → 함수 완료
- 시간 차이 계산 → 병목 구간 파악

---

## 🎓 마무리 체크리스트

프로젝트에 합류한 개발자가 확인해야 할 사항:

- [ ] `DATABASE_ARCHITECTURE.md` 읽기 완료
- [ ] `DATA_FLOW_DIAGRAM.md` (이 문서) 읽기 완료
- [ ] `lib/Database/schedule_database.dart` 함수 목록 파악
- [ ] `lib/model/` 테이블 정의 확인
- [ ] Quick Add 플로우 한 번 직접 따라가보기
- [ ] 콘솔 로그 패턴 익히기
- [ ] StreamBuilder vs FutureBuilder 차이 이해

---

**마지막 업데이트:** 2025-10-14  
**작성자:** Cursor AI + Junsung  
**연관 문서:** DATABASE_ARCHITECTURE.md

---

🎉 **모든 데이터 흐름을 완벽히 파악하셨습니다!**

