# 월뷰 동적 일정 개수 표시 구현 완료

## 📋 구현 개요

날짜 셀의 높이에 따라 동적으로 표시되는 일정의 개수를 계산하도록 개선했습니다.

---

## 🎯 요구사항

### 기존 방식 (변경 전)
- **고정값**: 모든 화면 크기에서 최대 5개의 일정만 표시
- **문제점**: 화면이 크거나 작을 때 최적화되지 않음

### 새로운 방식 (변경 후)
- **동적 계산**: 셀 높이에 따라 자동으로 최대 표시 개수 결정
- **공식**: `((셀의 높이 - 24) / 18) - 1 = 최대 일정 수`

---

## 🧮 계산 공식 상세

```dart
공식: ((셀의 높이 - 24) / 18) - 2 = 최대 일정 수

구성 요소:
- 24 = 상단 고정 영역 (4px padding + 22px 날짜 박스 + 2px gap 등)
- 18 = 일정 박스 하나당 차지하는 높이 (18px 박스 + 여백)
- -2 = "+숫자" 표시 및 overflow 방지를 위한 여유 공간 확보
```

### 계산 예시

| 셀 높이 | 계산 과정 | 최대 일정 수 |
|---------|-----------|--------------|
| 150px | (150 - 24) / 18 = 7 → 7 - 2 = **5개** | 5개 |
| 120px | (120 - 24) / 18 = 5.3 → 5 - 2 = **3개** | 3개 |
| 100px | (100 - 24) / 18 = 4.2 → 4 - 2 = **2개** | 2개 |
| 80px  | (80 - 24) / 18 = 3.1 → 3 - 2 = **1개** | 1개 |
| 50px  | (50 - 24) / 18 = 1.4 → 1 - 2 = -1 → **1개** (최소값) | 1개 |

---

## 📦 코드 구조

### 1. 동적 계산 함수 추가

**위치**: `lib/screen/home_screen.dart` 라인 620-646

```dart
int _calculateMaxScheduleCount(double cellHeight) {
  // 1. 입력값 유효성 검사
  if (cellHeight <= 0) {
    print('⚠️ [높이 계산] 유효하지 않은 셀 높이: $cellHeight → 기본값 1개 반환');
    return 1;
  }
  
  // 2. 사용 가능한 높이 계산
  final availableHeight = cellHeight - 24;
  
  // 3. 높이가 너무 작은 경우 처리
  if (availableHeight < 18) {
    print('⚠️ [높이 계산] 셀 높이가 너무 작음 → 최소값 1개 반환');
    return 1;
  }
  
  // 4. 일정 박스 개수 계산
  final maxCount = (availableHeight / 18).floor();
  
  // 5. "+숫자" 공간 및 overflow 방지를 위해 -2
  final finalCount = (maxCount - 2).clamp(1, 10);
  
  // 6. 계산 결과 로그
  print('📐 [높이 계산] 셀: ${cellHeight}px → 사용가능: ${availableHeight}px → 최대: $finalCount개');
  
  return finalCount;
}
```

### 2. LayoutBuilder 적용

**위치**: `lib/screen/home_screen.dart` 라인 814-841

**변경 전**:
```dart
Expanded(
  child: Builder(
    builder: (context) {
      const maxDisplayCount = 5; // ❌ 고정값
      // ...
    }
  )
)
```

**변경 후**:
```dart
Expanded(
  child: LayoutBuilder( // ✅ 높이 측정 가능
    builder: (context, constraints) {
      final cellHeight = constraints.maxHeight + 26;
      final maxDisplayCount = _calculateMaxScheduleCount(cellHeight); // ✅ 동적 계산
      // ...
    }
  )
)
```

---

## 📊 시각화: 셀 구조

```
┌─────────────────────────────────────────────┐
│  날짜 셀 (동적 높이)                          │
│  ┌─────────────────────────────────────┐   │
│  │ ⬆ 4px padding (top)                │   │
│  ├─────────────────────────────────────┤   │
│  │    [20]  ← 날짜 (22×22px)          │   │ } 24px (고정)
│  ├─────────────────────────────────────┤   │
│  │ ⬆ 2px gap                          │   │
│  ├─────────────────────────────────────┤   │
│  │ LayoutBuilder (constraints.maxHeight)│   │
│  │ ┌─────────────────────────────┐     │   │
│  │ │ ■ 일정1 (18px)              │     │   │ } 18px × N개
│  │ └─────────────────────────────┘     │   │   (동적)
│  │ ┌─────────────────────────────┐     │   │
│  │ │ ■ 일정2 (18px)              │     │   │
│  │ └─────────────────────────────┘     │   │
│  │ ...                                 │   │
│  │ +N  ← 남은 개수 (9px)               │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘

계산: (전체 높이 - 24) / 18 - 1 = 최대 일정 수
```

---

## ✅ 검증 로그 시스템

### 1. 높이 계산 로그
```dart
print('📐 [높이 계산] 셀 높이: 120.0px → 사용가능: 96.0px → 몫: 5 → 최대 일정: 4개');
```

### 2. 셀 검증 로그
```dart
print('🔍 [셀 검증] 2025-10-16 → Expanded 높이: 94.0px, 전체 셀: 120.0px');
```

### 3. 일정 표시 로그
```dart
print('📅 [셀] 2025-10-16 → 전체: 8개, 표시: 4개, 숨김: 4개');
```

### 4. 경고 로그
```dart
print('⚠️ [셀 검증] 경고! 표시 개수(6)가 최대값(4)을 초과함');
print('⚠️ [셀 검증] 경고! 남은 개수가 음수: -2');
```

---

## 🛡️ 안전장치

### 1. 최소값 보장
```dart
final finalCount = (maxCount - 1).clamp(1, 10);
//                                    ↑ 최소 1개
```

### 2. 최대값 제한
```dart
final finalCount = (maxCount - 1).clamp(1, 10);
//                                       ↑ 최대 10개
```

### 3. 입력값 검증
```dart
if (cellHeight <= 0) return 1;
if (availableHeight < 18) return 1;
```

---

## 🔄 코드 변경 요약

| 구분 | 변경 내용 | 라인 |
|------|-----------|------|
| **추가** | `_calculateMaxScheduleCount()` 함수 | 620-646 |
| **변경** | `Builder` → `LayoutBuilder` | 814 |
| **변경** | `const maxDisplayCount = 5` → 동적 계산 | 820 |
| **추가** | 셀 높이 측정 로직 | 819 |
| **추가** | 검증 로그 시스템 | 821-833 |

---

## 🎨 주요 특징

### ✅ 장점
1. **반응형**: 모든 화면 크기에 최적화
2. **효율적**: 셀 높이를 최대한 활용
3. **안정적**: 최소/최대값 보장
4. **디버깅 용이**: 상세한 로그 시스템

### 🔍 유지보수
- 계산 공식을 한 곳에서 관리
- 로그로 실시간 동작 확인 가능
- 경고 시스템으로 이상 상태 감지

---

## 📝 테스트 시나리오

### 1. 일반적인 경우
```
셀 높이: 120px
→ 최대 일정: 3개
→ 전체 8개 → 3개 표시 + "+5" 표시
```

### 2. 화면이 작은 경우
```
셀 높이: 80px
→ 최대 일정: 1개
→ 전체 5개 → 1개 표시 + "+4" 표시
```

### 3. 화면이 큰 경우
```
셀 높이: 200px
→ 최대 일정: 7개 (최대 10개 제한)
→ 전체 6개 → 6개 표시
```

### 4. 극단적인 경우
```
셀 높이: 40px (너무 작음)
→ 최소값 보장: 1개
→ 전체 10개 → 1개 표시 + "+9" 표시
```

---

## 🚀 실행 방법

2. 앱 실행
3. 월뷰 화면 확인
4. 콘솔에서 로그 확인:
   ```
   📐 [높이 계산] 셀 높이: 120.0px → 사용가능: 96.0px → 몫: 5 → 최대 일정: 3개
   🔍 [셀 검증] 2025-10-17 → Expanded 높이: 94.0px, 전체 셀: 120.0px
   📅 [셀] 2025-10-17 → 전체: 8개, 표시: 3개, 숨김: 5개
   ```

---

## 📌 주의사항

1. **LayoutBuilder 성능**: 매 빌드마다 계산되므로 성능 영향 최소화됨
2. **로그 양**: 개발 중 로그가 많을 수 있음 (필요시 주석 처리)
3. **디자인 일관성**: 피그마 디자인(18px 박스)과 정확히 일치

---

## 📅 작성 정보

- **작성일**: 2025-10-16
- **수정 파일**: `lib/screen/home_screen.dart`
- **관련 파일**: 
  - `lib/const/calendar_config.dart` (기존 설정 참고)
  - `lib/screen/date_detail_view.dart` (상세 화면)

---

## 🔗 관련 문서

- [QUICK_ADD_ANIMATION_COMPLETE.md](./QUICK_ADD_ANIMATION_COMPLETE.md)
- [KEYBOARD_FIXED_LAYOUT.md](./KEYBOARD_FIXED_LAYOUT.md)
- [FIGMA_DESIGN_ANALYSIS.md](./FIGMA_DESIGN_ANALYSIS.md)
