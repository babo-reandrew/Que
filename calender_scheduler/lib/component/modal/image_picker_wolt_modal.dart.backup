import 'package:flutter/material.dart';
import 'package:wolt_modal_sheet/wolt_modal_sheet.dart';
import 'package:wechat_assets_picker/wechat_assets_picker.dart';
import 'package:photo_manager/photo_manager.dart';
import 'package:flutter_svg/flutter_svg.dart'; // ğŸ“¸ SVG ì•„ì´ì½˜ ì¶”ê°€
import '../../design_system/wolt_common_widgets.dart';

/// ğŸ“¸ ì´ë¯¸ì§€ ì„ íƒ Wolt Modal Sheet
///
/// **Figma Design Spec:**
///
/// **Frame 847 - Modal Container:**
/// - Size: 393 x 651px
/// - Background: #FDFCFC
/// - Border: 1px solid rgba(17, 17, 17, 0.1)
/// - Shadow: 0px 2px 20px rgba(165, 165, 165, 0.2)
/// - Border radius: 36px
///
/// **TopNavi (54px):**
/// - Padding: 9px 28px
/// - Title: "ç”»åƒã§è¿½åŠ " - Bold 19px, #566099, LINE Seed JP
/// - Close Button: 36Ã—36px circle, background: rgba(228, 228, 228, 0.9)
///
/// **Frame 848 - Image Grid Container:**
/// - Size: 393 x 651px
/// - Background: #FEFDFD
/// - Overflow-y: scroll
/// - Gap: 1px
///
/// **Image_Area (ê° ìŠ¬ë¡¯):**
/// - Size: 130 x 232px
/// - Background (ë¯¸ì„ íƒ): linear-gradient(0deg, rgba(17, 17, 17, 0.05), rgba(17, 17, 17, 0.05)), #DDDDDD
/// - Background (ì„ íƒ): linear-gradient(0deg, rgba(17, 17, 17, 0.25), rgba(17, 17, 17, 0.25))
/// - Image_Selected: right: 9.23%, top: 5.17% (ìš°ìƒë‹¨)
///
/// **Camera Slot:**
/// - Icon: 40Ã—40px camera, border: 2px solid #555555
/// - Text: "ã‚«ãƒ¡ãƒ©" - 12px
void showImagePickerWoltModal(
  BuildContext context, {
  required Function(List<AssetEntity>) onImagesSelected,
}) {
  WoltModalSheet.show(
    context: context,
    pageListBuilder: (context) => [
      _buildImagePickerPage(context, onImagesSelected),
    ],
    modalTypeBuilder: (context) {
      // ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ: 768px ë¯¸ë§Œì€ BottomSheet, ì´ìƒì€ Dialog
      final width = MediaQuery.sizeOf(context).width;
      if (width < 768) {
        return WoltModalType.bottomSheet();
      } else {
        return WoltModalType.dialog();
      }
    },
    onModalDismissedWithBarrierTap: () {
      debugPrint('âœ… [ImagePickerWolt] Modal dismissed with tap');
    },
    onModalDismissedWithDrag: () {
      debugPrint('âœ… [ImagePickerWolt] Modal dismissed with drag');
    },
    useSafeArea: false,
  );
}

// ========================================
// Image Picker Page Builder
// ========================================

SliverWoltModalSheetPage _buildImagePickerPage(
  BuildContext context,
  Function(List<AssetEntity>) onImagesSelected,
) {
  return SliverWoltModalSheetPage(
    hasTopBarLayer: false,

    mainContentSliversBuilder: (context) => [
      SliverToBoxAdapter(
        child: Container(
          // Figma: Frame 847 ìŠ¤í™
          decoration: BoxDecoration(
            color: const Color(0xFFFDFCFC), // âœ… Figma ë°°ê²½ìƒ‰
            borderRadius: const BorderRadius.only(
              topLeft: Radius.circular(36),
              topRight: Radius.circular(36),
            ),
            border: Border.all(
              color: const Color(0xFF111111).withOpacity(0.1),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: const Color(0xFFA5A5A5).withOpacity(0.2),
                offset: const Offset(0, 2),
                blurRadius: 20,
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: const BorderRadius.only(
              topLeft: Radius.circular(36),
              topRight: Radius.circular(36),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // ========== TopNavi (54px) ==========
                _buildTopNavi(context),

                // ========== Image Grid (651px) ==========
                SizedBox(
                  height: 651, // Figma: Frame 848 height
                  child: _ImageGridView(
                    onImagesSelected: onImagesSelected,
                    onClose: () => Navigator.of(context).pop(),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    ],

    hasSabGradient: false, // ê·¸ë¼ë°ì´ì…˜ ë¹„í™œì„±í™” (í•„ìš”ì‹œ í™œì„±í™”)
  );
}

// ========================================
// TopNavi Header
// ========================================

Widget _buildTopNavi(BuildContext context) {
  return Container(
    height: 54, // Figma: TopNavi height
    padding: const EdgeInsets.symmetric(
      horizontal: 28,
      vertical: 9,
    ), // Figma: padding 9px 28px
    child: Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        // ë¹ˆ ê³µê°„ (ì™¼ìª½ ì •ë ¬ ìœ ì§€)
        const SizedBox.shrink(),

        // ì¤‘ì•™ íƒ€ì´í‹€: "ç”»åƒã§è¿½åŠ "
        Text(
          'ç”»åƒã§è¿½åŠ ',
          style: TextStyle(
            fontFamily: 'LINE Seed JP App_TTF',
            fontSize: 19, // Figma: font-size 19px
            fontWeight: FontWeight.w700, // Figma: font-weight 700
            height: 1.4, // Figma: line-height 140%
            letterSpacing: -0.005, // Figma: letter-spacing -0.005em
            color: const Color(0xFF566099), // Figma: color #566099
          ),
        ),

        // ë‹«ê¸° ë²„íŠ¼ (36Ã—36px)
        WoltCloseButton(),
      ],
    ),
  );
}

// ========================================
// Image Grid View (LazyLoading)
// ========================================

class _ImageGridView extends StatefulWidget {
  const _ImageGridView({
    required this.onImagesSelected,
    required this.onClose,
  });

  final Function(List<AssetEntity>) onImagesSelected;
  final VoidCallback onClose;

  @override
  State<_ImageGridView> createState() => _ImageGridViewState();
}

class _ImageGridViewState extends State<_ImageGridView> {
  AssetPathEntity? _currentPath;
  List<AssetEntity> _assets = [];
  List<AssetEntity> _selectedAssets = []; // ğŸ“¸ ì„ íƒëœ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
  int _totalCount = 0;
  int _currentPage = 0;
  bool _isLoading = false;
  bool _hasMore = true;

  static const int _pageSize = 50; // í•œ ë²ˆì— ë¡œë“œí•  ê°œìˆ˜ (LazyLoading)
  static const int _gridCount = 3; // Figma: 3ì—´ ë ˆì´ì•„ì›ƒ

  @override
  void initState() {
    super.initState();
    _loadAssets();
  }

  /// ğŸ“¸ ê¶Œí•œ ìš”ì²­ ë° ì•¨ë²” ì—ì…‹ ë¡œë“œ (LazyLoading)
  Future<void> _loadAssets() async {
    if (_isLoading || !_hasMore) return;

    setState(() => _isLoading = true);

    try {
      // 1. ê¶Œí•œ ìš”ì²­
      final PermissionState ps = await PhotoManager.requestPermissionExtend();
      if (!ps.isAuth) {
        debugPrint('âŒ [ImagePickerWolt] ê¶Œí•œ ê±°ë¶€ë¨');
        if (mounted) {
          _showPermissionDeniedDialog();
        }
        setState(() => _isLoading = false);
        return;
      }

      // 2. ì²« ë¡œë“œ: ì•¨ë²” ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
      if (_currentPath == null) {
        final List<AssetPathEntity> paths = await PhotoManager.getAssetPathList(
          type: RequestType.image,
          hasAll: true,
        );

        if (paths.isEmpty) {
          debugPrint('âš ï¸ [ImagePickerWolt] ì•¨ë²”ì´ ë¹„ì–´ìˆìŒ');
          setState(() {
            _isLoading = false;
            _hasMore = false;
          });
          return;
        }

        _currentPath = paths.first;
        _totalCount = await _currentPath!.assetCountAsync;
        debugPrint('âœ… [ImagePickerWolt] ì´ ì´ë¯¸ì§€ ê°œìˆ˜: $_totalCount');
      }

      // 3. í˜ì´ì§€ë³„ ì—ì…‹ ë¡œë“œ (LazyLoading)
      final List<AssetEntity> assets = await _currentPath!.getAssetListPaged(
        page: _currentPage,
        size: _pageSize,
      );

      debugPrint(
          'âœ… [ImagePickerWolt] Page $_currentPage ë¡œë“œ: ${assets.length}ê°œ');

      setState(() {
        _assets.addAll(assets);
        _currentPage++;
        _hasMore = _assets.length < _totalCount;
        _isLoading = false;
      });
    } catch (e) {
      debugPrint('âŒ [ImagePickerWolt] ì—ì…‹ ë¡œë“œ ì‹¤íŒ¨: $e');
      setState(() => _isLoading = false);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// ğŸš« ê¶Œí•œ ê±°ë¶€ ë‹¤ì´ì–¼ë¡œê·¸
  void _showPermissionDeniedDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€ãƒ•ã‚©ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
              PhotoManager.openSetting();
            },
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }

  /// ğŸ“· WeChat Assets Picker ì˜¤í”ˆ
  Future<void> _openAssetPicker() async {
    final List<AssetEntity>? result = await AssetPicker.pickAssets(
      context,
      pickerConfig: AssetPickerConfig(
        maxAssets: 999, // ë¬´ì œí•œì— ê°€ê¹Œìš´ í° ê°’
        requestType: RequestType.image,
        gridCount: _gridCount,
        pageSize: _pageSize,
        themeColor: const Color(0xFF566099), // Figma: #566099
        textDelegate: const AssetPickerTextDelegate(),
        specialItemPosition: SpecialItemPosition.none,
        // ì¸ë„¤ì¼ í¬ê¸° ìµœì í™”
        gridThumbnailSize: const ThumbnailSize.square(200),
        pathThumbnailSize: const ThumbnailSize.square(80),
      ),
    );

    if (result != null && result.isNotEmpty) {
      debugPrint('âœ… [ImagePickerWolt] ì„ íƒëœ ì´ë¯¸ì§€: ${result.length}ê°œ');
      widget.onImagesSelected(result);
      if (mounted) {
        Navigator.of(context).pop(); // Bottom Sheet ë‹«ê¸°
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ
        Expanded(
          child: Container(
            color: const Color(0xFFFEFDFD), // Figma: Frame 842 background
            child: CustomScrollView(
              slivers: [
                SliverPadding(
                  padding: EdgeInsets.zero,
                  sliver: SliverGrid(
                    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                      crossAxisCount: _gridCount,
                      crossAxisSpacing: 1, // Figma: gap 1px
                      mainAxisSpacing: 1, // Figma: gap 1px
                      childAspectRatio: 130 / 232, // Figma: width 130px / height 232px
                    ),
                    delegate: SliverChildBuilderDelegate(
                      (context, index) {
                        // ì²« ë²ˆì§¸ ìŠ¬ë¡¯: ì¹´ë©”ë¼ ë²„íŠ¼
                        if (index == 0) {
                          return _buildCameraSlot();
                        }

                        final assetIndex = index - 1;

                        // ì´ë¯¸ì§€ ë¡œë“œ
                        if (assetIndex < _assets.length) {
                          return _buildImageSlot(_assets[assetIndex]);
                        }

                        // ìŠ¤í¬ë¡¤ ëì— ë„ë‹¬: ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
                        if (assetIndex == _assets.length && _hasMore && !_isLoading) {
                          Future.microtask(() => _loadAssets());
                        }

                        // ë¡œë”© ì¸ë””ì¼€ì´í„°
                        if (_isLoading && assetIndex == _assets.length) {
                          return const Center(
                            child: CircularProgressIndicator(
                              color: Color(0xFF566099),
                            ),
                          );
                        }

                        return const SizedBox.shrink();
                      },
                      childCount: _assets.length + 1 + (_isLoading ? 1 : 0),
                      findChildIndexCallback: (Key key) {
                        if (key is ValueKey<String>) {
                          final index = _assets.indexWhere((asset) => asset.id == key.value);
                          return index >= 0 ? index + 1 : null;
                        }
                        return null;
                      },
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),

        // í•˜ë‹¨ ì•¡ì…˜ ë°” (ì„ íƒ ê°œìˆ˜ í‘œì‹œ)
        if (_selectedAssets.isNotEmpty)
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  offset: const Offset(0, -2),
                  blurRadius: 8,
                ),
              ],
            ),
            child: SafeArea(
              top: false,
              child: ElevatedButton(
                onPressed: () {
                  widget.onImagesSelected(_selectedAssets);
                  widget.onClose();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF566099),
                  minimumSize: const Size(double.infinity, 56),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Text(
                      'è¿½åŠ ',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(width: 8),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 12,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.3),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Text(
                        '${_selectedAssets.length}',
                        style: const TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
      ],
    );
  }
                      ),
                    );
                  }

                  return const SizedBox.shrink();
                },
                childCount: _assets.length + 1 + (_isLoading ? 1 : 0),
                findChildIndexCallback: (Key key) {
                  // ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤ ì°¾ê¸°
                  if (key is ValueKey<String>) {
                    final index = _assets.indexWhere((asset) => asset.id == key.value);
                    return index >= 0 ? index + 1 : null;
                  }
                  return null;
                },
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// ğŸ“· ì¹´ë©”ë¼ ìŠ¬ë¡¯ (ì²« ë²ˆì§¸ ìœ„ì¹˜)
  ///
  /// Figma: Image_Area - Camera
  /// - Size: 130 x 232px
  /// - Background: #D3D3D3 (ë¹„í™œì„±í™” ë°°ê²½ìƒ‰)
  /// - Icon: asset/icon/camera.svg
  Widget _buildCameraSlot() {
    return GestureDetector(
      onTap: _openAssetPicker,
      child: Container(
        decoration: const BoxDecoration(
          color: Color(0xFFD3D3D3), // Figma: #D3D3D3
        ),
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // ì¹´ë©”ë¼ SVG ì•„ì´ì½˜ (40Ã—40px)
              SvgPicture.asset(
                'asset/icon/camera.svg',
                width: 40,
                height: 40,
              ),
              const SizedBox(height: 8),
              // "ã‚«ãƒ¡ãƒ©" í…ìŠ¤íŠ¸
              const Text(
                'ã‚«ãƒ¡ãƒ©',
                style: TextStyle(
                  fontSize: 12,
                  fontWeight: FontWeight.w500,
                  color: Color(0xFF555555),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// ğŸ–¼ï¸ ì´ë¯¸ì§€ ìŠ¬ë¡¯ (ì„ íƒ ìƒíƒœ ê´€ë¦¬)
  ///
  /// Figma: Image_Area
  /// - Size: 130 x 232px
  /// - Background: #D3D3D3 (ë¯¸ì„ íƒ), rgba(17, 17, 17, 0.25) overlay (ì„ íƒ)
  /// - Image_Selected: right: 9.23%, top: 5.17%
  Widget _buildImageSlot(AssetEntity asset) {
    final isSelected = _selectedAssets.contains(asset);

    return GestureDetector(
      key: ValueKey<String>(asset.id),
      onTap: () {
        setState(() {
          if (isSelected) {
            // ì„ íƒ í•´ì œ
            _selectedAssets.remove(asset);
            debugPrint('âœ… [ImagePicker] ì´ë¯¸ì§€ ì„ íƒ í•´ì œ: ${asset.id}');
          } else {
            // ì„ íƒ ì¶”ê°€
            _selectedAssets.add(asset);
            debugPrint('âœ… [ImagePicker] ì´ë¯¸ì§€ ì„ íƒ: ${asset.id} (${_selectedAssets.length}ê°œ)');
          }
        });
      },
      child: RepaintBoundary(
        child: Stack(
          fit: StackFit.expand,
          children: [
            // 1. ì´ë¯¸ì§€ ì¸ë„¤ì¼
            AssetEntityImage(
              asset,
              isOriginal: false,
              thumbnailSize: const ThumbnailSize.square(200),
              fit: BoxFit.cover,
            ),

            // 2. ì„ íƒ ì˜¤ë²„ë ˆì´ (ì„ íƒ ì‹œì—ë§Œ í‘œì‹œ)
            if (isSelected)
              Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      const Color(0xFF111111).withOpacity(0.25),
                      const Color(0xFF111111).withOpacity(0.25),
                    ],
                  ),
                ),
              ),

            // 3. ì„ íƒ ì•„ì´ì½˜ (ìš°ìƒë‹¨)
            // Figma: left: 72.31%, right: 9.23%, top: 5.17%, bottom: 84.48%
            Positioned(
              right: 130 * 0.0923, // 9.23% from right
              top: 232 * 0.0517, // 5.17% from top
              child: SvgPicture.asset(
                isSelected 
                    ? 'asset/icon/Selected.svg' 
                    : 'asset/icon/NotSelected.svg',
                width: 24,
                height: 24,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
