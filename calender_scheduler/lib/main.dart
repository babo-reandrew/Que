import 'package:flutter/material.dart';
import 'package:provider/provider.dart' as provider; // âœ… prefix ì¶”ê°€
import 'package:flutter_riverpod/flutter_riverpod.dart'; // âœ… Riverpod ì¶”ê°€
import 'package:flutter_persistent_keyboard_height/flutter_persistent_keyboard_height.dart'; // âœ… í‚¤ë³´ë“œ ë†’ì´ ìœ ì§€
import 'package:flutter_dotenv/flutter_dotenv.dart'; // âœ… í™˜ê²½ ë³€ìˆ˜
import 'package:super_drag_and_drop/super_drag_and_drop.dart'; // ğŸ”¥ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¶”ê°€
import 'package:calender_scheduler/config/app_routes.dart';
import 'package:intl/date_symbol_data_local.dart';
import 'package:calender_scheduler/Database/schedule_database.dart';
import 'package:get_it/get_it.dart';
import 'package:calender_scheduler/providers/bottom_sheet_controller.dart';
import 'package:calender_scheduler/providers/schedule_form_controller.dart';
import 'package:calender_scheduler/providers/task_form_controller.dart';
import 'package:calender_scheduler/providers/habit_form_controller.dart';
import 'package:calender_scheduler/providers/image_analysis_provider.dart'; // âœ… ì¶”ê°€
import 'package:calender_scheduler/design_system/wolt_theme.dart';
import 'package:calender_scheduler/utils/temp_input_cache.dart'; // âœ… ì„ì‹œ ìºì‹œ ì´ˆê¸°í™”
// import 'package:calender_scheduler/utils/sample_data_helper.dart'; // âœ… ìƒ˜í”Œ ë°ì´í„° í—¬í¼ - ë¹„í™œì„±í™”

// ===================================================================
// â­ï¸ Main Entry Point: ì•±ì˜ ì§„ì…ì 
// ===================================================================
// ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ ì•± ì‹œì‘ ì „ í•„ìš”í•œ ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³ 
// ì´ê±°ë¥¼ í•´ì„œ â†’ ë°ì´í„°ë² ì´ìŠ¤, ë‚ ì§œ í¬ë§·, ì˜ì¡´ì„± ì£¼ì…ì„ ì¤€ë¹„í•œë‹¤
// ì´ê±°ëŠ” ì´ë˜ì„œ â†’ ì•±ì´ ì•ˆì •ì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•œë‹¤
// ì´ê±°ë¼ë©´ â†’ ì¤‘ì•™í™”ëœ ë¼ìš°íŠ¸ ì‹œìŠ¤í…œìœ¼ë¡œ í™”ë©´ ì „í™˜ì„ ê´€ë¦¬í•œë‹¤

void main() async {
  // ===================================================================
  // 1. Flutter í”„ë ˆì„ì›Œí¬ ì´ˆê¸°í™”
  // ===================================================================
  WidgetsFlutterBinding.ensureInitialized();
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ Flutter í”„ë ˆì„ì›Œí¬ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ async ì‘ì—…ì´ main í•¨ìˆ˜ì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰ëœë‹¤

  // ===================================================================
  // 2. ë‚ ì§œ í¬ë§· ì´ˆê¸°í™” (ë‹¤êµ­ì–´ ì§€ì›)
  // ===================================================================
  await initializeDateFormatting();
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ í•œêµ­ì–´ ë‚ ì§œ í¬ë§·ì„ ë¡œë“œí•´ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ "10ì›”", "ì›”ìš”ì¼" ê°™ì€ í•œêµ­ì–´ í‘œì‹œê°€ ê°€ëŠ¥í•˜ë‹¤

  // ===================================================================
  // 2.5 í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (.env íŒŒì¼)
  // ===================================================================
  try {
    await dotenv.load(fileName: '.env');
  } catch (e) {}

  // ===================================================================
  // 3. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ë° ì˜ì¡´ì„± ì£¼ì…
  // ===================================================================
  final database = AppDatabase();
  GetIt.instance.registerSingleton<AppDatabase>(database);
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ AppDatabase ì¸ìŠ¤í„´ìŠ¤ë¥¼ GetItì— ë“±ë¡í•´ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ ì–´ë””ì„œë“  GetIt.I<AppDatabase>()ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤
  // ì´ê±°ëŠ” ì´ë˜ì„œ â†’ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì „ì—­ìœ¼ë¡œ ê³µìœ í•˜ê³  ì¤‘ë³µ ìƒì„±ì„ ë°©ì§€í•œë‹¤

  // ===================================================================
  // 4. ğŸµ Insight Player ìƒ˜í”Œ ë°ì´í„° ì´ˆê¸°í™” (Phase 1)
  // ===================================================================
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ ì•± ì‹œì‘ ì‹œ ìƒ˜í”Œ ì¸ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ìë™ ì‚½ì…í•´ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ 2025-10-18 ë‚ ì§œì— í…ŒìŠ¤íŠ¸ìš© ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•œë‹¤
  await database.seedInsightData();

  // ===================================================================
  // 5. ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ì•± ì‹œì‘ ì‹œ ì˜¤ëŠ˜ ì¼ì • í™•ì¸)
  // ===================================================================
  final resp = await database.getSchedulesByDate(DateTime.now());

  // ===================================================================
  // 6. âœ… ìƒ˜í”Œ ë°ì´í„° ìƒì„± (Task, Habit í…ŒìŠ¤íŠ¸ìš©) - ë¹„í™œì„±í™”
  // ===================================================================
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ ì•± ì²« ì‹¤í–‰ ì‹œ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìƒì„±í•´ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ TaskCardì™€ HabitCard UIë¥¼ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤
  // TODO: ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ì´ ì½”ë“œë¥¼ ì œê±°í•˜ê±°ë‚˜ ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ ì‹¤í–‰
  // try {
  //   await SampleDataHelper.createAllSampleData(database);
  // } catch (e) {
  //   print('âš ï¸ [main.dart] ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ): $e');
  // }

  // ===================================================================
  // ğŸ§ª ì˜¤ëŠ˜ ë‚ ì§œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ (ë™ì  ì¼ì • ê°œìˆ˜ í…ŒìŠ¤íŠ¸ìš©) - ë¹„í™œì„±í™”
  // ===================================================================
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ ì˜¤ëŠ˜ ë‚ ì§œì— 5ê°œì˜ í…ŒìŠ¤íŠ¸ ì¼ì •ì„ ì¶”ê°€í•´ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ ì…€ ë†’ì´ ê¸°ë°˜ ë™ì  ì¼ì • ê°œìˆ˜ ê³„ì‚°ì„ í…ŒìŠ¤íŠ¸í•œë‹¤
  // try {
  //   await SampleDataHelper.createTodayTestSchedules(database);
  //   print('âœ… [main.dart] ì˜¤ëŠ˜ ë‚ ì§œ í…ŒìŠ¤íŠ¸ ì¼ì • 5ê°œ ì¶”ê°€ ì™„ë£Œ');
  // } catch (e) {
  //   print('âš ï¸ [main.dart] ì˜¤ëŠ˜ ë‚ ì§œ í…ŒìŠ¤íŠ¸ ì¼ì • ì¶”ê°€ ì‹¤íŒ¨: $e');
  // }

  // ===================================================================
  // 7. ì•± ì¬ì‹¤í–‰ ì‹œ ì„ì‹œ ìºì‹œ ì´ˆê¸°í™” (ì œëª© ì œì™¸)
  // ===================================================================
  // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ ì•± ì‹œì‘ ì‹œ ì„ì‹œ ì…ë ¥ ìºì‹œë¥¼ ì‚­ì œí•´ì„œ
  // ì´ê±°ë¥¼ í•´ì„œ â†’ ìƒ‰ìƒ, ë‚ ì§œ, ë°˜ë³µ ê·œì¹™, ë¦¬ë§ˆì¸ë”ê°€ ì´ˆê¸°í™”ëœë‹¤
  // ì´ê±°ëŠ” ì´ë˜ì„œ â†’ ì‚¬ìš©ìê°€ ì•±ì„ ìƒˆë¡œ ì—´ ë•Œë§ˆë‹¤ ê¹¨ë—í•œ ìƒíƒœë¡œ ì‹œì‘í•œë‹¤
  await TempInputCache.clearTempInput();
  await TempInputCache.clearAllUnifiedCache(); // í†µí•© ìºì‹œë„ ì´ˆê¸°í™” (ì œëª© ì œì™¸)

  // ===================================================================
  // 8. ì•± ì‹¤í–‰
  // ===================================================================
  runApp(const CalendarSchedulerApp());
}

// ===================================================================
// â­ï¸ Calendar Scheduler App: ì•±ì˜ ë£¨íŠ¸ ìœ„ì ¯
// ===================================================================
// ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ MaterialAppì— ì¤‘ì•™í™”ëœ ë¼ìš°íŠ¸ ì‹œìŠ¤í…œì„ ì ìš©í•´ì„œ
// ì´ê±°ë¥¼ í•´ì„œ â†’ ëª¨ë“  í™”ë©´ ì „í™˜ì„ ì¼ê´€ë˜ê²Œ ê´€ë¦¬í•œë‹¤
// ì´ê±°ëŠ” ì´ë˜ì„œ â†’ ì½”ë“œ ìœ ì§€ë³´ìˆ˜ê°€ ì‰½ê³  ë¼ìš°íŠ¸ ì¶”ê°€/ë³€ê²½ì´ ê°„ë‹¨í•˜ë‹¤

class CalendarSchedulerApp extends StatelessWidget {
  const CalendarSchedulerApp({super.key});

  @override
  Widget build(BuildContext context) {
    // âœ… Riverpod ProviderScopeë¡œ ì „ì²´ ì•± ê°ì‹¸ê¸°
    return ProviderScope(
      child: provider.MultiProvider(
        providers: [
          provider.ChangeNotifierProvider(
            create: (_) => BottomSheetController(),
          ),
          provider.ChangeNotifierProvider(
            create: (_) => ScheduleFormController(),
          ),
          provider.ChangeNotifierProvider(create: (_) => TaskFormController()),
          provider.ChangeNotifierProvider(create: (_) => HabitFormController()),
          // âœ… ImageAnalysisProvider ì¶”ê°€
          provider.ChangeNotifierProvider(
            create: (_) => ImageAnalysisProvider(),
          ),
        ],
        child: MaterialApp(
          // ===================================================================
          // ì•± ê¸°ë³¸ ì„¤ì •
          // ===================================================================
          title: 'Calendar Scheduler',
          theme: ThemeData(
            fontFamily: 'Gmarket Sans',
            // ===================================================================
            // â­ï¸ Wolt Modal Sheet í…Œë§ˆ ì ìš©
            // ===================================================================
            extensions: [WoltAppTheme.theme],
            // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ WoltModalSheetThemeDataë¥¼ ThemeData extensionì— ì¶”ê°€í•´ì„œ
            // ì´ê±°ë¥¼ í•´ì„œ â†’ ëª¨ë“  WoltModalSheetê°€ ì¼ê´€ëœ ë””ìì¸ ìŠ¤íƒ€ì¼ì„ ì‚¬ìš©í•œë‹¤
            // ì´ê±°ëŠ” ì´ë˜ì„œ â†’ Figma ë””ìì¸ í† í°ì´ ì „ì—­ì ìœ¼ë¡œ ì ìš©ëœë‹¤
            // ì´ê±°ë¼ë©´ â†’ ë°”í…€ì‹œíŠ¸ ìŠ¤íƒ€ì¼ ë³€ê²½ ì‹œ wolt_theme.dartë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤
          ),

          // ===================================================================
          // â­ï¸ í‚¤ë³´ë“œ ë†’ì´ ìœ ì§€ + ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™”
          // ===================================================================
          builder: (context, child) => DropRegion(
            formats: Formats.standardFormats,
            onDropOver: (event) => DropOperation.none, // ìµœìƒìœ„ì—ì„œëŠ” ë°˜ì‘ ì•ˆ í•¨
            onPerformDrop: (event) async {
              // ìµœìƒìœ„ì—ì„œëŠ” ë“œë¡­ì„ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (í•˜ìœ„ DropRegionì´ ì²˜ë¦¬)
            },
            child: PersistentKeyboardHeightProvider(child: child!),
          ),
          // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ DropRegionìœ¼ë¡œ ì „ì²´ ì•±ì„ ê°ì‹¸ì„œ
          // ì´ê±°ë¥¼ í•´ì„œ â†’ ëª¨ë“  í™”ë©´ì—ì„œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ì´ ì‘ë™í•œë‹¤
          // ì´ê±°ëŠ” ì´ë˜ì„œ â†’ ì¸ë°•ìŠ¤ ë°”í…€ì‹œíŠ¸ì—ì„œ ë””í…Œì¼ë·°ë¡œ ë“œë˜ê·¸ê°€ ê°€ëŠ¥í•˜ë‹¤
          // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ í‚¤ë³´ë“œ ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¸¡ì •í•˜ê³  ì €ì¥í•´ì„œ
          // ì´ê±°ë¥¼ í•´ì„œ â†’ í‚¤ë³´ë“œê°€ ë‚´ë ¤ê°€ë„ ê·¸ ë†’ì´ë¥¼ ìœ ì§€í•œë‹¤
          // ì´ê±°ëŠ” ì´ë˜ì„œ â†’ è¿½åŠ  ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ì°½ì´ ê³ ì •ëœ ìœ„ì¹˜ì— ìœ ì§€ëœë‹¤

          // ===================================================================
          // â­ï¸ ë¼ìš°íŠ¸ ì¤‘ì•™í™”: ëª¨ë“  í™”ë©´ ì „í™˜ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬
          // ===================================================================
          initialRoute: AppRoutes.home,
          onGenerateRoute: AppRoutes.onGenerateRoute,
          // ì´ê±°ë¥¼ ì„¤ì •í•˜ê³  â†’ AppRoutesì˜ onGenerateRouteë¥¼ ì‚¬ìš©í•´ì„œ
          // ì´ê±°ë¥¼ í•´ì„œ â†’ ë¼ìš°íŠ¸ ì´ë¦„ìœ¼ë¡œ í™”ë©´ì„ ìƒì„±í•˜ê³  ì• ë‹ˆë©”ì´ì…˜ì„ ì ìš©í•œë‹¤
          // ì´ê±°ëŠ” ì´ë˜ì„œ â†’ Navigator.pushNamed()ë§Œìœ¼ë¡œ ëª¨ë“  í™”ë©´ ì „í™˜ì´ ê°€ëŠ¥í•˜ë‹¤
          // ì´ê±°ë¼ë©´ â†’ ë¼ìš°íŠ¸ ê²½ë¡œë¥¼ ìˆ˜ì •í•  ë•Œ app_routes.dartë§Œ ë³€ê²½í•˜ë©´ ëœë‹¤

          // ===================================================================
          // ë””ë²„ê·¸ ë°°ë„ˆ ì œê±° (ë¦´ë¦¬ì¦ˆ ë¹Œë“œ ì‹œ)
          // ===================================================================
          debugShowCheckedModeBanner: false,
        ),
      ),
    );
  }
}
